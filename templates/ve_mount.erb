#!/bin/bash
. /etc/vz/vz.conf
. ${VE_CONFFILE}

<% @mounts.each do |mnt| %>
  <% if mnt['type'] == 'dataset_local' %>
    SRC="/<%= "#{mnt['pool_fs']}/#{mnt['dataset_name']}/private" %>"
    DST="<%= mnt['dst'] %>"
    if [ ! -e ${VE_ROOT}${DST} ]; then mkdir -p ${VE_ROOT}${DST}; fi
    mount <%= mnt['mount_opts'] %> ${SRC} ${VE_ROOT}${DST}

  <% elsif mnt['type'] == 'dataset_remote' %>
    SRC="<%= mnt['src_node_addr'] %>:/<%= "#{mnt['pool_fs']}/#{mnt['dataset_name']}/private" %>"
    DST="<%= mnt['dst'] %>"
    if [ ! -e ${VE_ROOT}${DST} ]; then mkdir -p ${VE_ROOT}${DST}; fi
    mount <%= mnt['mount_opts'] %> ${SRC} ${VE_ROOT}${DST}

  <% elsif mnt['type'] == 'snapshot_local' %>
    SRC="<%= "#{mnt['pool_fs']}/#{mnt['dataset_name']}@#{mnt['snapshot']}" %>"
    DST="<%= mnt['dst'] %>"
    if [ ! -e ${VE_ROOT}${DST} ]; then mkdir -p ${VE_ROOT}${DST}; fi
    mount <%= mnt['mount_opts'] %> ${SRC} ${VE_ROOT}${DST}

  <% elsif mnt['type'] == 'snapshot_remote' %>
    SRC="<%= "#{mnt['src_node_addr']}:/#{pool_mounted_snapshot(mnt['pool_fs'], mnt['snapshot_id'])}" %>"
    DST="<%= mnt['dst'] %>"
    if [ ! -e ${VE_ROOT}${DST} ]; then mkdir -p ${VE_ROOT}${DST}; fi
    mount <%= mnt['mount_opts'] %> ${SRC} ${VE_ROOT}${DST}

  <% else %>
    # Unknown mount type '<%= mnt['type'] %>
  <% end %>
<% end %>

exit 0
