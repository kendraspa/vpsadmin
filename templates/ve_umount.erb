#!/bin/bash
. /etc/vz/vz.conf
. ${VE_CONFFILE}

<% @mounts.reverse.each do |mnt| %>
  <% if mnt['type'] == 'zfs' %>
    zfs umount -f <%= "#{mnt['pool_fs']}/#{mnt['dataset']}" %>

  <% elsif mnt['type'] == 'snapshot_local' %>
      DST="<%= mnt['dst'] %>"
      if grep ${VE_ROOT}${DST} /proc/mounts; then umount -f ${VE_ROOT}${DST}; fi

  <% elsif mnt['type'] == 'snapshot_remote' %>
      # FIXME: snapshot_remote

  <% else %>
    SRC="<%= mnt['src'] %>"
    DST="<%= mnt['dst'] %>"
    if grep ${VE_ROOT}${DST} /proc/mounts; then umount <%= mnt['umount_opts'] %> ${VE_ROOT}${DST}; fi
  <% end %>
<% end %>

exit 0
